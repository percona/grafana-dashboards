/*! For license information please see module.js.LICENSE.txt */
define(["lodash","moment","jquery","app/core/app_events","@grafana/data","app/core/utils/kbn","app/plugins/sdk"],(function(e,t,i,n,o,s,a){return function(e){var t={};function i(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,i),o.l=!0,o.exports}return i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)i.d(n,o,function(t){return e[t]}.bind(null,o));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/",i(i.s=7)}([function(t,i){t.exports=e},function(e,i){e.exports=t},function(e,t){e.exports=i},function(e,t){e.exports=n},function(e,t){e.exports=o},function(e,t){e.exports=s},function(e,t){e.exports=a},function(e,t,i){"use strict";i.r(t);var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};function o(e,t){function i(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}function s(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],n=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}var a=i(6),r=i(1),l=i.n(r),h=i(2),u=i.n(h),d=i(3),p=i.n(d),c=function(e){function t(t,i){var n=e.call(this,t,i)||this;return n.data=null,n.mouse={position:null,down:null},n.$tooltip=u()('<div class="graph-tooltip">'),n.events.on("panel-initialized",n.onPanelInitialized.bind(n)),n.events.on("refresh",n.onRefresh.bind(n)),n.events.on("render",n.onRender.bind(n)),n._devicePixelRatio=1,void 0!==window.devicePixelRatio&&(n._devicePixelRatio=window.devicePixelRatio),n}return t.$inject=["$scope","$injector"],o(t,e),t.prototype.onPanelInitialized=function(){this.render()},t.prototype.onRefresh=function(){this.render()},t.prototype.onRender=function(){if(this.context){console.log("canvas render",this.mouse);var e=this.wrap.getBoundingClientRect(),t=Math.max(this.height,100),i=e.width;this.canvas.width=i,this.canvas.height=t;var n=t/2,o=this.context;o.lineWidth=1,o.textBaseline="middle";var s="";if(null!=this.mouse.position&&(s=this.dashboard.formatDate(l()(this.mouse.position.ts))),o.fillStyle="#999999",o.fillRect(0,0,i,t),o.fillStyle="#111111",o.font='24px "Open Sans", Helvetica, Arial, sans-serif',o.textAlign="left",o.fillText("Mouse @ "+s,10,n),null!=this.mouse.position)if(null!=this.mouse.down){var a=Math.min(this.mouse.position.x,this.mouse.down.x),r=Math.max(this.mouse.position.x,this.mouse.down.x);o.globalCompositeOperation="destination-out",o.fillStyle="rgba(255, 255, 255, 0.6)",o.beginPath(),o.fillRect(0,0,a,t),o.fill(),o.beginPath(),o.fillRect(r,0,i,t),o.fill(),o.globalCompositeOperation="source-over"}else o.strokeStyle="#111",o.beginPath(),o.moveTo(this.mouse.position.x,0),o.lineTo(this.mouse.position.x,t),o.lineWidth=3,o.stroke(),o.beginPath(),o.moveTo(this.mouse.position.x,0),o.lineTo(this.mouse.position.x,t),o.strokeStyle="#e22c14",o.lineWidth=2,o.stroke()}else console.log("No context!")},t.prototype.clearTT=function(){this.$tooltip.detach()},t.prototype.getMousePosition=function(e){var t=this.range.to-this.range.from,i=this.canvas.getBoundingClientRect(),n=e.offsetX,o=this.range.from+t*(n/parseFloat(i.width)),s=e.clientY-i.top;return{x:n,y:s,yRel:s/parseFloat(i.height),ts:o,evt:e}},t.prototype.onGraphHover=function(e,t,i){console.log("HOVER",e,t,i)},t.prototype.onMouseClicked=function(e,t){console.log("CANVAS CLICKED",e,t),this.render()},t.prototype.onMouseSelectedRange=function(e,t){console.log("CANVAS Range",e,t)},t.prototype.link=function(e,t,i,n){var o=this;this.wrap=t.find(".canvas-spot")[0],this.canvas=document.createElement("canvas"),this.wrap.appendChild(this.canvas),u()(this.canvas).css("cursor","pointer"),u()(this.wrap).css("width","100%"),this.context=this.canvas.getContext("2d"),this.canvas.addEventListener("mousemove",(function(e){if(o.range){o.mouse.position=o.getMousePosition(e);var t={pos:{pageX:e.pageX,pageY:e.pageY,x:o.mouse.position.ts,y:o.mouse.position.y,panelRelY:o.mouse.position.yRel,panelRelX:o.mouse.position.xRel},evt:e,panel:o.panel};p.a.emit("graph-hover",t),null!=o.mouse.down&&u()(o.canvas).css("cursor","col-resize")}}),!1),this.canvas.addEventListener("mouseout",(function(e){null==o.mouse.down&&(o.mouse.position=null,o.onRender(),o.$tooltip.detach(),p.a.emit("graph-hover-clear"))}),!1),this.canvas.addEventListener("mousedown",(function(e){o.mouse.down=o.getMousePosition(e)}),!1),this.canvas.addEventListener("mouseenter",(function(e){o.mouse.down&&!e.buttons&&(o.mouse.position=null,o.mouse.down=null,o.onRender(),o.$tooltip.detach(),p.a.emit("graph-hover-clear")),u()(o.canvas).css("cursor","pointer")}),!1),this.canvas.addEventListener("mouseup",(function(e){o.$tooltip.detach();var t=o.getMousePosition(e);if(null!=o.mouse.down)if(t.x===o.mouse.down.x&&t.y===o.mouse.down.y)o.mouse.position=null,o.mouse.down=null,o.onMouseClicked(t,e);else{var i=Math.min(o.mouse.down.ts,t.ts),n=Math.max(o.mouse.down.ts,t.ts),s={from:l.a.utc(i),to:l.a.utc(n)};o.mouse.position=t,o.onMouseSelectedRange(s,e)}o.mouse.down=null,o.mouse.position=null}),!1),this.canvas.addEventListener("dblclick",(function(e){o.mouse.position=null,o.mouse.down=null,o.onRender(),o.$tooltip.detach(),p.a.emit("graph-hover-clear"),console.log("TODO, ZOOM OUT")}),!0),p.a.on("graph-hover",(function(e){var t=e.panel.id===o.panel.id;if((o.dashboard.sharedTooltipModeEnabled()||t)&&!o.otherPanelInFullscreenMode()){if(!t){if(!e.pos.x||!o.range)return;var i=e.pos.x,n=o.canvas.getBoundingClientRect(),s=o.range.to-o.range.from,a=(i-o.range.from)/s*n.width;o.mouse.position={x:a,y:e.pos.panelRelY*n.height,yRel:e.pos.panelRelY,ts:i,gevt:e}}o.onGraphHover(e,t||!o.dashboard.sharedCrosshairModeOnly(),!t)}}),e),p.a.on("graph-hover-clear",(function(e,t){o.mouse.position=null,o.mouse.down=null,o.render(),o.$tooltip.detach()}),e)},t.prototype.time_format=function(e,t){return t<=45?"%H:%M:%S":t<=7200||e<=864e5?"%H:%M":t<=8e4?"%m/%d %H:%M":t<=2419200||e<=31536e6?"%m/%d":"%Y-%m"},t.prototype.getTimeResolution=function(e){var t=e/1e3;return t<=30?3e4:t<=60?6e4:t<=300?3e5:t<=600?6e5:t<=1800?18e5:t<=3600||t<=3600?36e5:t<=7200?72e5:t<=21600?216e5:t<=43200?432e5:t<=86400?864e5:t<=172800?1728e5:t<=604800?6048e5:t<=2592e3?2592e6:15552e6},t.prototype.roundDate=function(e,t){return e-=e%t},t.prototype.formatDate=function(e,t){var i=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],n=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];if("function"==typeof e.strftime)return e.strftime(t);var o,s=[],a=!1,r=e.getHours(),l=r<12;o=r>12?r-12:0===r?12:r;for(var h=0;h<t.length;++h){var u=t.charAt(h);if(a){switch(u){case"a":u=""+n[e.getDay()];break;case"b":u=""+i[e.getMonth()];break;case"d":u=this.leftPad(e.getDate(),"");break;case"e":u=this.leftPad(e.getDate()," ");break;case"h":case"H":u=this.leftPad(r,null);break;case"I":u=this.leftPad(o,null);break;case"l":u=this.leftPad(o," ");break;case"m":u=this.leftPad(e.getMonth()+1,"");break;case"M":u=this.leftPad(e.getMinutes(),null);break;case"q":u=""+(Math.floor(e.getMonth()/3)+1);break;case"S":u=this.leftPad(e.getSeconds(),null);break;case"y":u=this.leftPad(e.getFullYear()%100,null);break;case"Y":u=""+e.getFullYear();break;case"p":u=l?"am":"pm";break;case"P":u=l?"AM":"PM";break;case"w":u=""+e.getDay()}s.push(u),a=!1}else"%"===u?a=!0:s.push(u)}return s.join("")},t.prototype.leftPad=function(e,t){return t=""+(null==t?"0":t),1===(e=""+e).length?t+e:e},t}(a.MetricsPanelCtrl),f=i(0),m=i.n(f),g=function(){function e(e){this.name=e,this.changes=[],this.legendInfo=[],this.last=null,this.asc=!1,this.transitionCount=0,this.distinctValuesCount=0,this.elapsed=0}return e.prototype.add=function(e,t){if(null==this.last)this.last={val:t,start:e,ms:0},this.changes.push(this.last);else{if(e===this.last.start)return void console.log("skip point with duplicate timestamp",e,t);if(1===this.changes.length&&(this.asc=e>this.last.start),e>this.last.start!==this.asc)return void console.log("skip out of order point",e,t);t===this.last.val?this.asc||(this.last.start=e):(this.last={val:t,start:e,ms:0},this.changes.push(this.last))}},e.prototype.finish=function(e){var t=this;if(this.changes.length<1)console.log("no points found!");else if(this.asc||(this.last=this.changes[0],m.a.reverse(this.changes)),this.last){if(this.last.start<e.range.to){var i=e.range.to+1;this.changes.push({val:this.last.val,start:i,ms:0})}this.transitionCount=0;for(var n=new Map,o=this.changes[0],s=1;s<this.changes.length;s++){var a=this.changes[s],r=o.start,l=a.start;if(r<e.range.from?r=e.range.from:r<e.range.to&&this.transitionCount++,l>e.range.to&&(l=e.range.to),o.ms=l-r,o.ms>0)if(n.has(o.val)){var h=n.get(o.val);h.ms+=o.ms,h.count++}else n.set(o.val,{val:o.val,ms:o.ms,count:1,per:0});o=a}var u=e.range.to-e.range.from;this.elapsed=u,n.forEach((function(e,i){e.per=e.ms/u,t.legendInfo.push(e)})),this.distinctValuesCount=m.a.size(this.legendInfo),e.isTimeline||(this.legendInfo=m.a.orderBy(this.legendInfo,["ms"],["desc"]))}},e.combineLegend=function(t,i){if(1===t.length)return t[0];var n=new e("merged"),o=0,s=new Map;return m.a.forEach(t,(function(e){n.transitionCount+=e.transitionCount,o+=e.elapsed,m.a.forEach(e.legendInfo,(function(e){if(s.has(e.val)){var t=s.get(e.val);t.ms+=e.ms,t.count+=e.count}else s.set(e.val,{val:e.val,ms:e.ms,count:e.count,per:0})}))})),n.elapsed=o,s.forEach((function(e,t){e.per=e.ms/o,n.legendInfo.push(e)})),n.distinctValuesCount=m.a.size(n.legendInfo),n},e}(),v=i(4),y=i(5),x=i.n(y);i.d(t,"getProcessedDataFrames",(function(){return D})),i.d(t,"PanelCtrl",(function(){return b}));var w=["#7EB26D","#EAB839","#6ED0E0","#EF843C","#E24D42","#1F78C1","#BA43A9","#705DA0","#508642","#CCA300","#447EBC","#C15C17","#890F02","#0A437C","#6D1F62","#584477","#B7DBAB","#F4D598","#70DBED","#F9BA8F","#F29191","#82B5D8","#E5A8E2","#AEA2E0","#629E51","#E5AC0E","#64B0C8","#E0752D","#BF1B00","#0A50A1","#962D82","#614D93","#9AC48A","#F2C96D","#65C5DB","#F9934E","#EA6460","#5195CE","#D683CE","#806EB7","#3F6833","#967302","#2F575E","#99440A","#58140C","#052B51","#511749","#3F2B5B","#E0F9D7","#FCEACA","#CFFAFF","#F9E2D2","#FCE2DE","#BADFF4","#F9D9F9","#DEDAF7"],b=function(e){function t(t,i,n){var o=e.call(this,t,i)||this;o.annotationsSrv=n,o.defaults={display:"timeline",rowHeight:50,valueMaps:[{value:"null",op:"=",text:"N/A"}],rangeMaps:[{from:"null",to:"null",text:"N/A"}],colorMaps:[{text:"N/A",color:"#CCC"}],metricNameColor:"#000000",valueTextColor:"#000000",timeTextColor:"#d8d9da",crosshairColor:"#8F070C",backgroundColor:"rgba(128,128,128,0.1)",lineColor:"rgba(0,0,0,0.1)",textSize:24,textSizeTime:12,extendLastValue:!0,writeLastValue:!0,writeAllValues:!1,writeMetricNames:!1,showTimeAxis:!0,showLegend:!0,showLegendNames:!0,showLegendValues:!0,showLegendPercent:!0,highlightOnMouseover:!0,expandFromQueryS:0,legendSortBy:"-ms",units:"short",timeOptions:[{name:"Years",value:"years"},{name:"Months",value:"months"},{name:"Weeks",value:"weeks"},{name:"Days",value:"days"},{name:"Hours",value:"hours"},{name:"Minutes",value:"minutes"},{name:"Seconds",value:"seconds"},{name:"Milliseconds",value:"milliseconds"}],timePrecision:{name:"Minutes",value:"minutes"},useTimePrecision:!1,use12HourClock:!1},o.annotations=[],o.data=[],o.legend=[],o.externalPT=!1,o.isTimeline=!0,o.isStacked=!1,o.hoverPoint=null,o.colorMap={},o.unitFormats=null,o.formatter=null,o._colorsPaleteCash=null,o._renderDimensions={},o._selectionMatrix=[],o.fieldNamer=function(e,t,i){return e.config.displayName?e.config.displayName:e.name},m.a.defaultsDeep(o.panel,o.defaults),o.panel.display="timeline",o.events.on("init-edit-mode",o.onInitEditMode.bind(o)),o.events.on("render",o.onRender.bind(o)),o.events.on("refresh",o.onRefresh.bind(o)),o.useDataFrames=!0,o.events.on("data-frames-received",o.onDataFramesReceived.bind(o)),o.events.on("data-snapshot-load",o.onSnapshotLoad.bind(o)),o.events.on("data-error",o.onDataError.bind(o));try{"a"===Object(v.getFieldDisplayName)({name:"a",config:{},type:v.FieldType.number,values:new v.ArrayVector([])})&&(o.fieldNamer=v.getFieldDisplayName)}catch(e){console.warn("Using 6x style field names",e)}return o}return t.$inject=["$scope","$injector","annotationsSrv"],o(t,e),t.prototype.onPanelInitialized=function(){this.updateColorInfo(),this.onConfigChanged()},t.prototype.onDataError=function(e){this.annotations=[],console.log("onDataError",e)},t.prototype.onInitEditMode=function(){this.unitFormats=x.a.getUnitFormats(),this.addEditorTab("Options","public/plugins/natel-discrete-panel/partials/editor.options.html",1),this.addEditorTab("Legend","public/plugins/natel-discrete-panel/partials/editor.legend.html",3),this.addEditorTab("Colors","public/plugins/natel-discrete-panel/partials/editor.colors.html",4),this.addEditorTab("Mappings","public/plugins/natel-discrete-panel/partials/editor.mappings.html",5),this.editorTabIndex=1,this.refresh()},t.prototype.onRender=function(){null!=this.data&&this.context&&(this._updateRenderDimensions(),this._updateSelectionMatrix(),this._updateCanvasSize(),this._renderRects(),this._renderTimeAxis(),this._renderLabels(),this._renderAnnotations(),this._renderSelection(),this._renderCrosshair(),this.renderingCompleted())},t.prototype.showLegandTooltip=function(e,t){var i='<div class="graph-tooltip-time">'+t.val+"</div>";i+="<center>",t.count>1&&(i+=t.count+" times<br/>for<br/>"),i+=this.formatDuration(l.a.duration(t.ms)),t.count>1&&(i+="<br/>total"),i+="</center>",this.$tooltip.html(i).place_tt(e.pageX+20,e.pageY)},t.prototype.clearTT=function(){this.$tooltip.detach()},t.prototype.formatValue=function(e){if(m.a.isNumber(e)){if(this.panel.rangeMaps)for(var t=0;t<this.panel.rangeMaps.length;t++){var i=this.panel.rangeMaps[t],n=parseFloat(i.from);if(parseFloat(i.to)>=e&&n<=e)return i.text}this.formatter&&(e=this.formatter(e,this.panel.decimals))}var o=m.a.isNil(e);o||m.a.isString(e)||(e=e.toString());for(t=0;t<this.panel.valueMaps.length;t++){if("null"!==(i=this.panel.valueMaps[t]).value){if(e===i.value)return i.text}else if(o)return i.text}return o?"null":e},t.prototype.getColor=function(e){if(m.a.has(this.colorMap,e))return this.colorMap[e];if(void 0===this._colorsPaleteCash[e]){var t=w[this._colorsPaleteCash.length%w.length];this._colorsPaleteCash[e]=t,this._colorsPaleteCash.length++}return this._colorsPaleteCash[e]},t.prototype.randomColor=function(){for(var e="ABCDE".split(""),t="#",i=0;i<3;i++)t+=e[Math.floor(Math.random()*e.length)];return t},t.prototype.applyPanelTimeOverrides=function(){if(e.prototype.applyPanelTimeOverrides.call(this),this.panel.expandFromQueryS&&this.panel.expandFromQueryS>0){var t=this.range.from.subtract(this.panel.expandFromQueryS,"s");this.range.from=t,this.range.raw.from=t}},t.prototype.onSnapshotLoad=function(e){this.onDataFramesReceived(D(e))},t.prototype.onDataFramesReceived=function(e){var t=this;u()(this.canvas).css("cursor","pointer");var i=[];e.forEach((function(n){var o=Object(v.getTimeField)(n).timeField;o&&n.fields.forEach((function(s){if(s!==o){for(var a=new g(t.fieldNamer(s,n,e)),r=0;r<o.values.length;r++)a.add(o.values.get(r),t.formatValue(s.values.get(r)));a.finish(t),i.push(a)}}))})),this.data=i,this.updateLegendMetrics(),this.annotationsSrv.getAnnotations({dashboard:this.dashboard,panel:this.panel,range:this.range}).then((function(e){t.loading=!1,e.annotations&&e.annotations.length>0?t.annotations=e.annotations:t.annotations=null,t.onRender()}),(function(){t.loading=!1,t.annotations=null,t.onRender(),console.log("ERRR",t)}))},t.prototype.updateLegendMetrics=function(e){!this.data||!this.panel.showLegend||this.panel.showLegendNames||this.data.length<=1?this.legend=this.data:this.legend=[g.combineLegend(this.data,this)],e&&this.onConfigChanged()},t.prototype.removeColorMap=function(e){var t=m.a.indexOf(this.panel.colorMaps,e);this.panel.colorMaps.splice(t,1),this.updateColorInfo()},t.prototype.updateColorInfo=function(){for(var e={},t=0;t<this.panel.colorMaps.length;t++){var i=this.panel.colorMaps[t];i.text&&(e[i.text]=i.color)}this._colorsPaleteCash={},this._colorsPaleteCash.length=0,this.colorMap=e,this.render()},t.prototype.addColorMap=function(e){var t=this;"curent"===e?m.a.forEach(this.data,(function(e){e.legendInfo&&m.a.forEach(e.legendInfo,(function(e){if(!m.a.has(t.colorMap,e.val)){var i={text:e.val,color:t.getColor(e.val)};t.panel.colorMaps.push(i),t.colorMap[e.val]=i}}))})):this.panel.colorMaps.push({text:"???",color:this.randomColor()}),this.updateColorInfo()},t.prototype.removeValueMap=function(e){var t=m.a.indexOf(this.panel.valueMaps,e);this.panel.valueMaps.splice(t,1),this.render()},t.prototype.addValueMap=function(){this.panel.valueMaps.push({value:"",op:"=",text:""})},t.prototype.removeRangeMap=function(e){var t=m.a.indexOf(this.panel.rangeMaps,e);this.panel.rangeMaps.splice(t,1),this.render()},t.prototype.addRangeMap=function(){this.panel.rangeMaps.push({from:"",to:"",text:""})},t.prototype.onConfigChanged=function(e){void 0===e&&(e=!1),this.isTimeline="timeline"===this.panel.display,this.isStacked="stacked"===this.panel.display,this.formatter=null,this.panel.units&&"none"!==this.panel.units&&(this.formatter=x.a.valueFormats[this.panel.units]),e?this.refresh():this.render()},t.prototype.formatDuration=function(e){var t,i;if(!this.panel.useTimePrecision)return e.humanize();var n={},o=!1,a=!1;try{for(var r=s(this.panel.timeOptions),h=r.next();!h.done;h=r.next()){var u=h.value;if(n[u.value]=parseInt(e.as(u.value),10),o=n[u.value]||o,e.subtract(l.a.duration(n[u.value],u.value)),(a=this.panel.timePrecision.value===u.value||a)&&o)break}}catch(e){t={error:e}}finally{try{h&&!h.done&&(i=r.return)&&i.call(r)}finally{if(t)throw t.error}}var d=Object.keys(n).reduce((function(e,t){var i=n[t];return i?e+" "+i+" "+(t=i<2?t.replace(/s$/,""):t)+",":e}),"");return d.substr(0,d.length-1)},t.prototype.getLegendDisplay=function(e,t){var i=e.val;if(this.panel.showLegendPercent||this.panel.showLegendCounts||this.panel.showLegendTime){i+=" (";var n=!1;if(this.panel.showLegendTime&&(i+=this.formatDuration(l.a.duration(e.ms)),n=!0),this.panel.showLegendPercent){n&&(i+=", ");var o=this.panel.legendPercentDecimals;m.a.isNil(o)&&(o=e.per>.98&&t.changes.length>1||e.per<.02?2:0),i+=x.a.valueFormats.percentunit(e.per,o),n=!0}this.panel.showLegendCounts&&(n&&(i+=", "),i+=e.count+"x"),i+=")"}return i},t.prototype.showTooltip=function(e,t,i){var n=t.start,o=t.start+t.ms,s=t.ms,a=t.val;null!=this.mouse.down&&(n=Math.min(this.mouse.down.ts,this.mouse.position.ts),s=(o=Math.max(this.mouse.down.ts,this.mouse.position.ts))-n,a="Zoom To:");var r="";this.panel.use12HourClock&&(r="YYYY-MM-DD h:mm:ss a");var h='<div class="graph-tooltip-time">'+a+"</div>";h+="<center>",h+=this.dashboard.formatDate(l()(n),r)+"<br/>",h+="to<br/>",h+=this.dashboard.formatDate(l()(o),r)+"<br/><br/>",h+=this.formatDuration(l.a.duration(s))+"<br/>",h+="</center>";var d=0,p=0;if(i){var c=this.canvas.getBoundingClientRect();if((p=c.top+e.pos.panelRelY*c.height)<0||p>u()(window).innerHeight())return void this.$tooltip.detach();p+=u()(window).scrollTop();var f=this.range.to-this.range.from,m=(e.pos.x-this.range.from)/f;d=c.left+m*c.width}else d=e.evt.pageX,p=e.evt.pageY;this.$tooltip.html(h).place_tt(d+20,p+5)},t.prototype.getCorrectTime=function(e){var t=l()(this.range.from).valueOf();return e<t?t:e},t.prototype.onGraphHover=function(e,t,i){if(this.externalPT=!1,this.data&&this.data.length){var n=null,o=Math.floor(this.mouse.position.y/this.panel.rowHeight);if(o<0&&(o=0),o>=this.data.length&&(o=this.data.length-1),this.isTimeline){n=this.data[o].changes[0];for(var s=0;s<this.data[o].changes.length&&!(this.data[o].changes[s].start>this.mouse.position.ts);s++)n=this.data[o].changes[s];if(n.start=this.getCorrectTime(n.start),this.hoverPoint=n,this.annotations&&!i&&this._renderDimensions&&e.pos.y>this._renderDimensions.rowsHeight-5){var a=m.a.isUndefined(this.range.from)?null:this.range.from.valueOf(),r=m.a.isUndefined(this.range.to)?null:this.range.to.valueOf(),l=this._renderDimensions.width,h=m.a.find(this.annotations,(function(t){if(t.isRegion)return e.pos.x>t.time&&e.pos.x<t.timeEnd;var i=(t.time-a)/(r-a)*l,n=e.evt.offsetX;return i>n-5&&i<n+5}));if(h)return console.log("TODO, hover <annotation-tooltip>",h),void this.$tooltip.html(h.text).place_tt(e.evt.pageX+20,e.evt.pageY+5)}t&&(this.externalPT=i,this.showTooltip(e,n,i)),this.onRender()}else i||this.isStacked&&(n=this.data[o].legendInfo[0],this.hoverPoint=n,this.onRender(),t&&(this.externalPT=i,this.showLegandTooltip(e.evt,n)))}else this.$tooltip.detach()},t.prototype.onMouseClicked=function(e,t){if(!0!==t.metaKey&&!0!==t.ctrlKey){var i=this.hoverPoint;if(i&&i.start){var n={from:l.a.utc(i.start),to:l.a.utc(i.start+i.ms)};this.timeSrv.setTime(n),this.clear()}}else console.log("TODO? Create Annotation?",e,t)},t.prototype.onMouseSelectedRange=function(e,t){!0!==t.metaKey&&!0!==t.ctrlKey?(this.timeSrv.setTime(e),this.clear()):console.log("TODO? Create range annotation?",e,t)},t.prototype.clear=function(){this.mouse.position=null,this.mouse.down=null,this.hoverPoint=null,u()(this.canvas).css("cursor","wait"),p.a.emit("graph-hover-clear"),this.render()},t.prototype._updateRenderDimensions=function(){var e=this;this._renderDimensions={};var t=this._renderDimensions.rect=this.wrap.getBoundingClientRect(),i=this._renderDimensions.rows=this.data.length,n=this._renderDimensions.rowHeight=this.panel.rowHeight,o=this._renderDimensions.rowsHeight=n*i,s=this.panel.showTimeAxis?14+this.panel.textSizeTime:0,a=this._renderDimensions.height=o+s,r=this._renderDimensions.width=t.width;this._renderDimensions.height=a,this.range||(this.range={to:2e3,from:1e3});var l=0,h=this.range.to-this.range.from;this._renderDimensions.matrix=[],m.a.forEach(this.data,(function(t){var i=[];if(e.isTimeline)for(var o=t.changes[0],s=0;s<t.changes.length;s++)if((o=t.changes[s]).start<=e.range.to){var a=Math.max(o.start-e.range.from,0)/h*r;i.push(a)}if(e.isStacked){o=void 0;var u=e.range.from;for(s=0;s<t.legendInfo.length;s++){o=t.legendInfo[s];a=Math.max(u-e.range.from,0)/h*r;i.push(a),u+=o.ms}}e._renderDimensions.matrix.push({y:l,positions:i}),l+=n}))},t.prototype._updateSelectionMatrix=function(){var e={all:function(){return!0},crosshairHover:function(e,t){return t+1===this.data[e].changes.length?this.data[e].changes[t].start<=this.mouse.position.ts:this.data[e].changes[t].start<=this.mouse.position.ts&&this.mouse.position.ts<this.data[e].changes[t+1].start},mouseX:function(e,t){var i=this._renderDimensions.matrix[e];return t+1===i.positions.length?i.positions[t]<=this.mouse.position.x:i.positions[t]<=this.mouse.position.x&&this.mouse.position.x<i.positions[t+1]},metric:function(e){return this.data[e]===this._selectedMetric},legendItem:function(e,t){return this.data[e]===this._selectedMetric&&this._selectedLegendItem.val===this._getVal(e,t)}}[function(){if(void 0!==this._selectedLegendItem)return"legendItem";if(void 0!==this._selectedMetric)return"metric";if(null!==this.mouse.down)return"all";if(this.panel.highlightOnMouseover&&null!=this.mouse.position){if(this.isTimeline)return"crosshairHover";if(this.isStacked)return"mouseX"}return"all"}.bind(this)()].bind(this);this._selectionMatrix=[];for(var t=0;t<this._renderDimensions.matrix.length;t++){for(var i=[],n=this._renderDimensions.matrix[t],o=0;o<n.positions.length;o++)i.push(e(t,o));this._selectionMatrix.push(i)}},t.prototype._updateCanvasSize=function(){this.canvas.width=this._renderDimensions.width*this._devicePixelRatio,this.canvas.height=this._renderDimensions.height*this._devicePixelRatio,u()(this.canvas).css("width",this._renderDimensions.width+"px"),u()(this.canvas).css("height",this._renderDimensions.height+"px"),this.context.scale(this._devicePixelRatio,this._devicePixelRatio)},t.prototype._getVal=function(e,t){var i;return this.isTimeline&&(i=this.data[e].changes[t]),this.isStacked&&(i=this.data[e].legendInfo[t]),i.val},t.prototype._renderRects=function(){var e=this,t=this._renderDimensions.matrix,i=this.context;i.fillStyle=this.panel.backgroundColor,i.fillRect(0,0,this.canvas.width,this.canvas.height),m.a.forEach(this.data,(function(n,o){for(var s=t[o],a=0;a<s.positions.length;a++){var r=s.positions[a],l=e._renderDimensions.width;a+1!==s.positions.length&&(l=s.positions[a+1]),i.fillStyle=e.getColor(e._getVal(o,a));var h=i.globalAlpha;e._selectionMatrix[o][a]||(i.globalAlpha=.3),i.fillRect(r,t[o].y,l-r,e._renderDimensions.rowHeight),i.globalAlpha=h}if(o>0){var u=t[o].y;i.strokeStyle=e.panel.lineColor,i.beginPath(),i.moveTo(0,u),i.lineTo(e._renderDimensions.width,u),i.stroke()}}))},t.prototype._renderLabels=function(){var e=this,t=this.context;t.lineWidth=1,t.textBaseline="middle",t.font=this.panel.textSize+'px "Open Sans", Helvetica, Arial, sans-serif';var i=this._renderDimensions.rowHeight;m.a.forEach(this.data,(function(n,o){var s=e._renderDimensions.matrix[o],a=s.y,r=s.positions,l=a+i/2,h=l,u=l,d=l,p=0,c=e._renderDimensions.width;e.panel.writeMetricNames&&(t.fillStyle=e.panel.metricNameColor,t.textAlign="left",t.fillText(n.name,2,h),p=2+t.measureText(n.name).width+2);var f=-1,m=-1;if(e.mouse.position)for(var g=0;g<r.length;g++)if(r[g]<=e.mouse.position.x&&(g>=r.length-1||r[g+1]>=e.mouse.position.x)){var v=e._getVal(o,g);t.fillStyle=e.panel.valueTextColor,t.textAlign="left",(f=r[g]+2)<p&&(f=p+2,v=": "+v),t.fillText(v,f,d),m=f+(y=t.measureText(v)).width+4;break}if(e.panel.writeLastValue){v=e._getVal(o,r.length-1);t.fillStyle=e.panel.valueTextColor,t.textAlign="right";var y=t.measureText(v);e._renderDimensions.width-2-y.width>m&&(t.fillText(v,e._renderDimensions.width-2,u),c=e._renderDimensions.width-t.measureText(v).width-10)}if(e.panel.writeAllValues){t.fillStyle=e.panel.valueTextColor,t.textAlign="left";for(g=0;g<r.length;g++){v=e._getVal(o,g);var x=e._renderDimensions.width;g+1!==r.length&&(x=r[g+1]);var w=r[g];if(w>p){var b=x-w;c>w+b&&(t.save(),t.rect(w,a,b,i),t.clip(),t.fillText(v,w+2,d),t.restore())}}}}))},t.prototype._renderSelection=function(){if(null!==this.mouse.down&&null!==this.mouse.position&&this.isTimeline){var e=this.context,t=this._renderDimensions.height,i=Math.min(this.mouse.position.x,this.mouse.down.x),n=Math.max(this.mouse.position.x,this.mouse.down.x);e.fillStyle="rgba(110, 110, 110, 0.5)",e.strokeStyle="rgba(110, 110, 110, 0.5)",e.beginPath(),e.fillRect(i,0,n-i,t),e.strokeRect(i,0,n-i,t)}},t.prototype._renderTimeAxis=function(){if(this.panel.showTimeAxis){var e=this.context,t=this._renderDimensions.width,i=this._renderDimensions.rowsHeight;e.font=this.panel.textSizeTime+'px "Open Sans", Helvetica, Arial, sans-serif',e.fillStyle=this.panel.timeTextColor,e.textAlign="left",e.strokeStyle=this.panel.timeTextColor,e.textBaseline="top",e.setLineDash([7,5]),e.lineDashOffset=0;var n=m.a.isUndefined(this.range.from)?null:this.range.from.valueOf(),o=m.a.isUndefined(this.range.to)?null:this.range.to.valueOf(),s=(o-n)/(t/(2*e.measureText("12/33 24:59").width)),a=this.getTimeResolution(s),r=a/(o-n)*t,l=this.roundDate(n,a)+a,h=0+(l-n)/(o-n)*t,u=this.time_format(o-n,a/1e3),d=0;for("utc"===this.dashboard.getTimezone()&&(d=6e4*(new Date).getTimezoneOffset());l<o;){e.beginPath(),e.moveTo(h,i+5),e.lineTo(h,0),e.lineWidth=1,e.stroke();var p=new Date(l+d),c=this.formatDate(p,u),f=e.measureText(c).width/2;e.fillText(c,h-f,i+10),l+=a,h+=r}}},t.prototype._renderCrosshair=function(){if(null==this.mouse.down&&null!==this.mouse.position&&this.isTimeline){var e=this.context,t=this.data.length,i=this._renderDimensions.height;e.beginPath(),e.moveTo(this.mouse.position.x,0),e.lineTo(this.mouse.position.x,i),e.strokeStyle=this.panel.crosshairColor,e.setLineDash([]),e.lineWidth=1,e.stroke(),this.externalPT&&t>1&&(e.beginPath(),e.arc(this.mouse.position.x,this.mouse.position.y,3,0,2*Math.PI,!1),e.fillStyle=this.panel.crosshairColor,e.fill(),e.lineWidth=1)}},t.prototype._renderAnnotations=function(){var e=this;if(this.panel.showTimeAxis&&this.annotations){var t=this.context,i=this.panel.rowHeight,n=this._renderDimensions.width,o=this._renderDimensions.rowsHeight;t.font=this.panel.textSizeTime+'px "Open Sans", Helvetica, Arial, sans-serif',t.fillStyle="#7FE9FF",t.textAlign="left",t.strokeStyle="#7FE9FF",t.textBaseline="top",t.setLineDash([3,3]),t.lineDashOffset=0,t.lineWidth=2;var s=m.a.isUndefined(this.range.from)?null:this.range.from.valueOf(),a=m.a.isUndefined(this.range.to)?null:this.range.to.valueOf();m.a.forEach(this.annotations,(function(r){t.setLineDash([3,3]);var l=!1;if(r.source.iconColor?(t.fillStyle=r.source.iconColor,t.strokeStyle=r.source.iconColor):void 0===r.annotation?(t.fillStyle="#7FE9FF",t.strokeStyle="#7FE9FF"):(l=!0,t.fillStyle="#EA0F3B",t.strokeStyle="#EA0F3B"),e._drawVertical(t,r.time,s,a,0,o,n,l),r.isRegion){e._drawVertical(t,r.timeEnd,s,a,0,o,n,l);var h=0+(r.time-s)/(a-s)*n,u=0+(r.timeEnd-s)/(a-s)*n;t.beginPath(),t.moveTo(h,o+5),t.lineTo(u,o+5),t.lineWidth=4,t.setLineDash([]),t.stroke(),!1===l&&(t.save(),t.fillStyle="#7FE9FF",t.globalAlpha=.2,t.fillRect(h,0,u-h,i),t.stroke(),t.restore())}}))}},t.prototype._drawVertical=function(e,t,i,n,o,s,a,r){var l=o+(t-i)/(n-i)*a;if(e.lineWidth=1,e.beginPath(),e.moveTo(l,s+5),e.lineTo(l,0),e.stroke(),e.moveTo(l+0,s),e.lineTo(l-5,s+7),e.lineTo(l+5,s+7),e.fill(),!0===r){var h=e.measureText("▲").width/2;e.fillText("▲",l-h,s+10)}},t.templateUrl="partials/module.html",t.scrollable=!0,t}(c);function D(e){var t,i,n,o;if(!e||!Object(f.isArray)(e))return[];var a=[];try{for(var r=s(e),l=r.next();!l.done;l=r.next()){var h=l.value,u=Object(v.guessFieldTypes)(Object(v.toDataFrame)(h));try{for(var d=(n=void 0,s(u.fields)),p=d.next();!p.done;p=d.next()){var c=p.value;c.calcs=void 0,c.state=void 0}}catch(e){n={error:e}}finally{try{p&&!p.done&&(o=d.return)&&o.call(d)}finally{if(n)throw n.error}}a.push(u)}}catch(e){t={error:e}}finally{try{l&&!l.done&&(i=r.return)&&i.call(r)}finally{if(t)throw t.error}}return a}}])}));
//# sourceMappingURL=module.js.map