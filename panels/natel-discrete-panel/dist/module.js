define(["moment","jquery","app/core/app_events","lodash","app/plugins/sdk","app/core/utils/kbn"],function(e,t,n,i,o,s){return function(e){var t={};function n(i){if(t[i])return t[i].exports;var o=t[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(i,o,function(t){return e[t]}.bind(null,o));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=4)}([function(t,n){t.exports=e},function(e,n){e.exports=t},function(e,t){e.exports=n},function(e,t){e.exports=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PanelCtrl=void 0;var i=n(5),o=n(7),s=u(n(3)),a=u(n(1)),r=u(n(0)),l=u(n(8)),h=u(n(2));function u(e){return e&&e.__esModule?e:{default:e}}var d,p=(d=function(e,t){return(d=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}d(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),c=["#7EB26D","#EAB839","#6ED0E0","#EF843C","#E24D42","#1F78C1","#BA43A9","#705DA0","#508642","#CCA300","#447EBC","#C15C17","#890F02","#0A437C","#6D1F62","#584477","#B7DBAB","#F4D598","#70DBED","#F9BA8F","#F29191","#82B5D8","#E5A8E2","#AEA2E0","#629E51","#E5AC0E","#64B0C8","#E0752D","#BF1B00","#0A50A1","#962D82","#614D93","#9AC48A","#F2C96D","#65C5DB","#F9934E","#EA6460","#5195CE","#D683CE","#806EB7","#3F6833","#967302","#2F575E","#99440A","#58140C","#052B51","#511749","#3F2B5B","#E0F9D7","#FCEACA","#CFFAFF","#F9E2D2","#FCE2DE","#BADFF4","#F9D9F9","#DEDAF7"],f=function(e){function t(t,n,i){var o=e.call(this,t,n)||this;return o.annotationsSrv=i,o.defaults={display:"timeline",rowHeight:50,valueMaps:[{value:"null",op:"=",text:"N/A"}],rangeMaps:[{from:"null",to:"null",text:"N/A"}],colorMaps:[{text:"N/A",color:"#CCC"}],metricNameColor:"#000000",valueTextColor:"#000000",timeTextColor:"#d8d9da",crosshairColor:"#8F070C",backgroundColor:"rgba(128,128,128,0.1)",lineColor:"rgba(0,0,0,0.1)",textSize:24,textSizeTime:12,extendLastValue:!0,writeLastValue:!0,writeAllValues:!1,writeMetricNames:!1,showTimeAxis:!0,showLegend:!0,showLegendNames:!0,showLegendValues:!0,showLegendPercent:!0,highlightOnMouseover:!0,expandFromQueryS:0,legendSortBy:"-ms",units:"short",timeOptions:[{name:"Years",value:"years"},{name:"Months",value:"months"},{name:"Weeks",value:"weeks"},{name:"Days",value:"days"},{name:"Hours",value:"hours"},{name:"Minutes",value:"minutes"},{name:"Seconds",value:"seconds"},{name:"Milliseconds",value:"milliseconds"}],timePrecision:{name:"Minutes",value:"minutes"},useTimePrecision:!1},o.annotations=[],o.data=null,o.legend=null,o.externalPT=!1,o.isTimeline=!0,o.isStacked=!1,o.hoverPoint=null,o.colorMap={},o.unitFormats=null,o.formatter=null,o._colorsPaleteCash=null,o._renderDimensions={},o._selectionMatrix=[],s.default.defaultsDeep(o.panel,o.defaults),o.panel.display="timeline",o.events.on("init-edit-mode",o.onInitEditMode.bind(o)),o.events.on("render",o.onRender.bind(o)),o.events.on("refresh",o.onRefresh.bind(o)),o.events.on("data-received",o.onDataReceived.bind(o)),o.events.on("data-snapshot-load",o.onDataSnapshotLoad.bind(o)),o.events.on("data-error",o.onDataError.bind(o)),o}return p(t,e),t.$inject=["$scope","$injector","annotationsSrv"],t.prototype.onPanelInitialized=function(){this.updateColorInfo(),this.onConfigChanged()},t.prototype.onDataSnapshotLoad=function(e){this.onDataReceived(e)},t.prototype.onDataError=function(e){this.annotations=[],console.log("onDataError",e)},t.prototype.onInitEditMode=function(){this.unitFormats=l.default.getUnitFormats(),this.addEditorTab("Options","public/plugins/natel-discrete-panel/partials/editor.options.html",1),this.addEditorTab("Legend","public/plugins/natel-discrete-panel/partials/editor.legend.html",3),this.addEditorTab("Colors","public/plugins/natel-discrete-panel/partials/editor.colors.html",4),this.addEditorTab("Mappings","public/plugins/natel-discrete-panel/partials/editor.mappings.html",5),this.editorTabIndex=1,this.refresh()},t.prototype.onRender=function(){null!=this.data&&this.context&&(this._updateRenderDimensions(),this._updateSelectionMatrix(),this._updateCanvasSize(),this._renderRects(),this._renderTimeAxis(),this._renderLabels(),this._renderAnnotations(),this._renderSelection(),this._renderCrosshair(),this.renderingCompleted())},t.prototype.showLegandTooltip=function(e,t){var n='<div class="graph-tooltip-time">'+t.val+"</div>";n+="<center>",1<t.count&&(n+=t.count+" times<br/>for<br/>"),n+=this.formatDuration(r.default.duration(t.ms)),1<t.count&&(n+="<br/>total"),n+="</center>",this.$tooltip.html(n).place_tt(e.pageX+20,e.pageY)},t.prototype.clearTT=function(){this.$tooltip.detach()},t.prototype.formatValue=function(e){if(s.default.isNumber(e)){if(this.panel.rangeMaps)for(var t=0;t<this.panel.rangeMaps.length;t++){var n=this.panel.rangeMaps[t],i=parseFloat(n.from);if(e<=parseFloat(n.to)&&i<=e)return n.text}this.formatter&&(e=this.formatter(e,this.panel.decimals))}var o=s.default.isNil(e);for(o||s.default.isString(e)||(e=e.toString()),t=0;t<this.panel.valueMaps.length;t++)if("null"!==(n=this.panel.valueMaps[t]).value){if(e===n.value)return n.text}else if(o)return n.text;return o?"null":e},t.prototype.getColor=function(e){if(s.default.has(this.colorMap,e))return this.colorMap[e];if(void 0===this._colorsPaleteCash[e]){var t=c[this._colorsPaleteCash.length%c.length];this._colorsPaleteCash[e]=t,this._colorsPaleteCash.length++}return this._colorsPaleteCash[e]},t.prototype.randomColor=function(){for(var e="ABCDE".split(""),t="#",n=0;n<3;n++)t+=e[Math.floor(Math.random()*e.length)];return t},t.prototype.applyPanelTimeOverrides=function(){if(e.prototype.applyPanelTimeOverrides.call(this),this.panel.expandFromQueryS&&0<this.panel.expandFromQueryS){var t=this.range.from.subtract(this.panel.expandFromQueryS,"s");this.range.from=t,this.range.raw.from=t}},t.prototype.onDataReceived=function(e){var t=this;(0,a.default)(this.canvas).css("cursor","pointer");var n=[];s.default.forEach(e,function(e){if("table"===e.type){if("time"!==e.columns[0].type)throw new Error("Expected a time column from the table format");for(var i=1;i<e.columns.length;i++){for(var a=new o.DistinctPoints(e.columns[i].text),r=0;r<e.rows.length;r++){var l=e.rows[r];a.add(l[0],t.formatValue(l[i]))}a.finish(t),n.push(a)}}else{var h=new o.DistinctPoints(e.target);s.default.forEach(e.datapoints,function(e){h.add(e[1],t.formatValue(e[0]))}),h.finish(t),n.push(h)}}),this.data=n,this.updateLegendMetrics(),this.annotationsSrv.getAnnotations({dashboard:this.dashboard,panel:this.panel,range:this.range}).then(function(e){t.loading=!1,e.annotations&&0<e.annotations.length?t.annotations=e.annotations:t.annotations=null,t.onRender()},function(){t.loading=!1,t.annotations=null,t.onRender(),console.log("ERRR",t)})},t.prototype.updateLegendMetrics=function(e){!this.data||!this.panel.showLegend||this.panel.showLegendNames||this.data.length<=1?this.legend=this.data:this.legend=[o.DistinctPoints.combineLegend(this.data,this)],e&&this.onConfigChanged()},t.prototype.removeColorMap=function(e){var t=s.default.indexOf(this.panel.colorMaps,e);this.panel.colorMaps.splice(t,1),this.updateColorInfo()},t.prototype.updateColorInfo=function(){for(var e={},t=0;t<this.panel.colorMaps.length;t++){var n=this.panel.colorMaps[t];n.text&&(e[n.text]=n.color)}this._colorsPaleteCash={},this._colorsPaleteCash.length=0,this.colorMap=e,this.render()},t.prototype.addColorMap=function(e){var t=this;"curent"===e?s.default.forEach(this.data,function(e){e.legendInfo&&s.default.forEach(e.legendInfo,function(e){if(!s.default.has(t.colorMap,e.val)){var n={text:e.val,color:t.getColor(e.val)};t.panel.colorMaps.push(n),t.colorMap[e.val]=n}})}):this.panel.colorMaps.push({text:"???",color:this.randomColor()}),this.updateColorInfo()},t.prototype.removeValueMap=function(e){var t=s.default.indexOf(this.panel.valueMaps,e);this.panel.valueMaps.splice(t,1),this.render()},t.prototype.addValueMap=function(){this.panel.valueMaps.push({value:"",op:"=",text:""})},t.prototype.removeRangeMap=function(e){var t=s.default.indexOf(this.panel.rangeMaps,e);this.panel.rangeMaps.splice(t,1),this.render()},t.prototype.addRangeMap=function(){this.panel.rangeMaps.push({from:"",to:"",text:""})},t.prototype.onConfigChanged=function(e){void 0===e&&(e=!1),this.isTimeline="timeline"===this.panel.display,this.isStacked="stacked"===this.panel.display,this.formatter=null,this.panel.units&&"none"!==this.panel.units&&(this.formatter=l.default.valueFormats[this.panel.units]),e?this.refresh():this.render()},t.prototype.formatDuration=function(e){if(!this.panel.useTimePrecision)return e.humanize();for(var t={},n=!1,i=!1,o=0,s=this.panel.timeOptions;o<s.length;o++){var a=s[o];if(t[a.value]=parseInt(e.as(a.value),10),n=t[a.value]||n,e.subtract(r.default.duration(t[a.value],a.value)),(i=this.panel.timePrecision.value===a.value||i)&&n)break}var l=Object.keys(t).reduce(function(e,n){var i=t[n];return i?e+" "+i+" "+(n=i<2?n.replace(/s$/,""):n)+",":e},"");return l.substr(0,l.length-1)},t.prototype.getLegendDisplay=function(e,t){var n=e.val;if(this.panel.showLegendPercent||this.panel.showLegendCounts||this.panel.showLegendTime){n+=" (";var i=!1;if(this.panel.showLegendTime&&(n+=this.formatDuration(r.default.duration(e.ms)),i=!0),this.panel.showLegendPercent){i&&(n+=", ");var o=this.panel.legendPercentDecimals;s.default.isNil(o)&&(o=.98<e.per&&1<t.changes.length?2:e.per<.02?2:0),n+=l.default.valueFormats.percentunit(e.per,o),i=!0}this.panel.showLegendCounts&&(i&&(n+=", "),n+=e.count+"x"),n+=")"}return n},t.prototype.showTooltip=function(e,t,n){var i=t.start,o=t.start+t.ms,s=t.ms,l=t.val;null!=this.mouse.down&&(i=Math.min(this.mouse.down.ts,this.mouse.position.ts),s=(o=Math.max(this.mouse.down.ts,this.mouse.position.ts))-i,l="Zoom To:");var h='<div class="graph-tooltip-time">'+l+"</div>";h+="<center>",h+=this.dashboard.formatDate((0,r.default)(i))+"<br/>",h+="to<br/>",h+=this.dashboard.formatDate((0,r.default)(o))+"<br/><br/>",h+=this.formatDuration(r.default.duration(s))+"<br/>",h+="</center>";var u=0,d=0;if(n){var p=this.canvas.getBoundingClientRect();if((d=p.top+e.pos.panelRelY*p.height)<0||d>(0,a.default)(window).innerHeight())return void this.$tooltip.detach();d+=(0,a.default)(window).scrollTop();var c=this.range.to-this.range.from,f=(e.pos.x-this.range.from)/c;u=p.left+f*p.width}else u=e.evt.pageX,d=e.evt.pageY;this.$tooltip.html(h).place_tt(u+20,d+5)},t.prototype.onGraphHover=function(e,t,n){if(this.externalPT=!1,this.data&&this.data.length){var i=null,o=Math.floor(this.mouse.position.y/this.panel.rowHeight);if(o<0&&(o=0),o>=this.data.length&&(o=this.data.length-1),this.isTimeline){i=this.data[o].changes[0];for(var a=0;a<this.data[o].changes.length&&!(this.data[o].changes[a].start>this.mouse.position.ts);a++)i=this.data[o].changes[a];if(this.hoverPoint=i,this.annotations&&!n&&this._renderDimensions&&e.pos.y>this._renderDimensions.rowsHeight-5){var r=s.default.isUndefined(this.range.from)?null:this.range.from.valueOf(),l=s.default.isUndefined(this.range.to)?null:this.range.to.valueOf(),h=this._renderDimensions.width,u=s.default.find(this.annotations,function(t){if(t.isRegion)return e.pos.x>t.time&&e.pos.x<t.timeEnd;var n=(t.time-r)/(l-r)*h,i=e.evt.offsetX;return i-5<n&&n<i+5});if(u)return console.log("TODO, hover <annotation-tooltip>",u),void this.$tooltip.html(u.text).place_tt(e.evt.pageX+20,e.evt.pageY+5)}t&&(this.externalPT=n,this.showTooltip(e,i,n)),this.onRender()}else n||this.isStacked&&(i=this.data[o].legendInfo[0],this.hoverPoint=i,this.onRender(),t&&(this.externalPT=n,this.showLegandTooltip(e.evt,i)))}else this.$tooltip.detach()},t.prototype.onMouseClicked=function(e,t){if(!0!==t.metaKey&&!0!==t.ctrlKey){var n=this.hoverPoint;if(n&&n.start){var i={from:r.default.utc(n.start),to:r.default.utc(n.start+n.ms)};this.timeSrv.setTime(i),this.clear()}}else console.log("TODO? Create Annotation?",e,t)},t.prototype.onMouseSelectedRange=function(e,t){!0!==t.metaKey&&!0!==t.ctrlKey?(this.timeSrv.setTime(e),this.clear()):console.log("TODO? Create range annotation?",e,t)},t.prototype.clear=function(){this.mouse.position=null,this.mouse.down=null,this.hoverPoint=null,(0,a.default)(this.canvas).css("cursor","wait"),h.default.emit("graph-hover-clear"),this.render()},t.prototype._updateRenderDimensions=function(){var e=this;this._renderDimensions={};var t=this._renderDimensions.rect=this.wrap.getBoundingClientRect(),n=this._renderDimensions.rows=this.data.length,i=this._renderDimensions.rowHeight=this.panel.rowHeight,o=this._renderDimensions.rowsHeight=i*n,a=this.panel.showTimeAxis?14+this.panel.textSizeTime:0,r=this._renderDimensions.height=o+a,l=this._renderDimensions.width=t.width;this._renderDimensions.height=r;var h=0,u=this.range.to-this.range.from;this._renderDimensions.matrix=[],s.default.forEach(this.data,function(t){var n=[];if(e.isTimeline)for(var o=t.changes[0],s=0;s<t.changes.length;s++)if((o=t.changes[s]).start<=e.range.to){var a=Math.max(o.start-e.range.from,0)/u*l;n.push(a)}if(e.isStacked){o=null;var r=e.range.from;for(s=0;s<t.legendInfo.length;s++)o=t.legendInfo[s],a=Math.max(r-e.range.from,0)/u*l,n.push(a),r+=o.ms}e._renderDimensions.matrix.push({y:h,positions:n}),h+=i})},t.prototype._updateSelectionMatrix=function(){var e={all:function(){return!0},crosshairHover:function(e,t){return t+1===this.data[e].changes.length?this.data[e].changes[t].start<=this.mouse.position.ts:this.data[e].changes[t].start<=this.mouse.position.ts&&this.mouse.position.ts<this.data[e].changes[t+1].start},mouseX:function(e,t){var n=this._renderDimensions.matrix[e];return t+1===n.positions.length?n.positions[t]<=this.mouse.position.x:n.positions[t]<=this.mouse.position.x&&this.mouse.position.x<n.positions[t+1]},metric:function(e){return this.data[e]===this._selectedMetric},legendItem:function(e,t){return this.data[e]===this._selectedMetric&&this._selectedLegendItem.val===this._getVal(e,t)}}[function(){if(void 0!==this._selectedLegendItem)return"legendItem";if(void 0!==this._selectedMetric)return"metric";if(null!==this.mouse.down)return"all";if(this.panel.highlightOnMouseover&&null!=this.mouse.position){if(this.isTimeline)return"crosshairHover";if(this.isStacked)return"mouseX"}return"all"}.bind(this)()].bind(this);this._selectionMatrix=[];for(var t=0;t<this._renderDimensions.matrix.length;t++){for(var n=[],i=this._renderDimensions.matrix[t],o=0;o<i.positions.length;o++)n.push(e(t,o));this._selectionMatrix.push(n)}},t.prototype._updateCanvasSize=function(){this.canvas.width=this._renderDimensions.width*this._devicePixelRatio,this.canvas.height=this._renderDimensions.height*this._devicePixelRatio,(0,a.default)(this.canvas).css("width",this._renderDimensions.width+"px"),(0,a.default)(this.canvas).css("height",this._renderDimensions.height+"px"),this.context.scale(this._devicePixelRatio,this._devicePixelRatio)},t.prototype._getVal=function(e,t){var n=void 0;return this.isTimeline&&(n=this.data[e].changes[t]),this.isStacked&&(n=this.data[e].legendInfo[t]),n.val},t.prototype._renderRects=function(){var e=this,t=this._renderDimensions.matrix,n=this.context;n.fillStyle=this.panel.backgroundColor,n.fillRect(0,0,this.canvas.width,this.canvas.height),s.default.forEach(this.data,function(i,o){for(var s=t[o],a=0;a<s.positions.length;a++){var r=s.positions[a],l=e._renderDimensions.width;a+1!==s.positions.length&&(l=s.positions[a+1]),n.fillStyle=e.getColor(e._getVal(o,a));var h=n.globalAlpha;e._selectionMatrix[o][a]||(n.globalAlpha=.3),n.fillRect(r,t[o].y,l-r,e._renderDimensions.rowHeight),n.globalAlpha=h}if(0<o){var u=t[o].y;n.strokeStyle=e.panel.lineColor,n.beginPath(),n.moveTo(0,u),n.lineTo(e._renderDimensions.width,u),n.stroke()}})},t.prototype._renderLabels=function(){var e=this,t=this.context;t.lineWidth=1,t.textBaseline="middle",t.font=this.panel.textSize+'px "Open Sans", Helvetica, Arial, sans-serif';var n=this._renderDimensions.rowHeight;s.default.forEach(this.data,function(i,o){var s=e._renderDimensions.matrix[o],a=s.y,r=s.positions,l=a+n/2,h=l,u=l,d=l,p=0,c=e._renderDimensions.width;e.panel.writeMetricNames&&(t.fillStyle=e.panel.metricNameColor,t.textAlign="left",t.fillText(i.name,2,h),p=2+t.measureText(i.name).width+2);var f=-1,m=-1;if(e.mouse.position)for(var g=0;g<r.length;g++)if(r[g]<=e.mouse.position.x&&(g>=r.length-1||r[g+1]>=e.mouse.position.x)){var v=e._getVal(o,g);t.fillStyle=e.panel.valueTextColor,t.textAlign="left",(f=r[g]+2)<p&&(f=p+2,v=": "+v),t.fillText(v,f,d),m=f+(x=t.measureText(v)).width+4;break}if(e.panel.writeLastValue){v=e._getVal(o,r.length-1),t.fillStyle=e.panel.valueTextColor,t.textAlign="right";var x=t.measureText(v);m<e._renderDimensions.width-2-x.width&&(t.fillText(v,e._renderDimensions.width-2,u),c=e._renderDimensions.width-t.measureText(v).width-10)}if(e.panel.writeAllValues)for(t.fillStyle=e.panel.valueTextColor,t.textAlign="left",g=0;g<r.length;g++){v=e._getVal(o,g);var y=e._renderDimensions.width;g+1!==r.length&&(y=r[g+1]);var w=r[g];if(p<w){var _=y-w;w+_<c&&(t.save(),t.rect(w,a,_,n),t.clip(),t.fillText(v,w+2,d),t.restore())}}})},t.prototype._renderSelection=function(){if(null!==this.mouse.down&&null!==this.mouse.position&&this.isTimeline){var e=this.context,t=this._renderDimensions.height,n=Math.min(this.mouse.position.x,this.mouse.down.x),i=Math.max(this.mouse.position.x,this.mouse.down.x);e.fillStyle="rgba(110, 110, 110, 0.5)",e.strokeStyle="rgba(110, 110, 110, 0.5)",e.beginPath(),e.fillRect(n,0,i-n,t),e.strokeRect(n,0,i-n,t)}},t.prototype._renderTimeAxis=function(){if(this.panel.showTimeAxis){var e=this.context,t=this._renderDimensions.width,n=this._renderDimensions.rowsHeight;e.font=this.panel.textSizeTime+'px "Open Sans", Helvetica, Arial, sans-serif',e.fillStyle=this.panel.timeTextColor,e.textAlign="left",e.strokeStyle=this.panel.timeTextColor,e.textBaseline="top",e.setLineDash([7,5]),e.lineDashOffset=0;var i=s.default.isUndefined(this.range.from)?null:this.range.from.valueOf(),o=s.default.isUndefined(this.range.to)?null:this.range.to.valueOf(),a=(o-i)/(t/(2*e.measureText("12/33 24:59").width)),r=this.getTimeResolution(a),l=r/(o-i)*t,h=this.roundDate(i,r)+r,u=0+(h-i)/(o-i)*t,d=this.time_format(o-i,r/1e3),p=0;for("utc"===this.dashboard.timezone&&(p=6e4*(new Date).getTimezoneOffset());h<o;){e.beginPath(),e.moveTo(u,n+5),e.lineTo(u,0),e.lineWidth=1,e.stroke();var c=new Date(h+p),f=this.formatDate(c,d),m=e.measureText(f).width/2;e.fillText(f,u-m,n+10),h+=r,u+=l}}},t.prototype._renderCrosshair=function(){if(null==this.mouse.down&&null!==this.mouse.position&&this.isTimeline){var e=this.context,t=this.data.length,n=this._renderDimensions.height;e.beginPath(),e.moveTo(this.mouse.position.x,0),e.lineTo(this.mouse.position.x,n),e.strokeStyle=this.panel.crosshairColor,e.setLineDash([]),e.lineWidth=1,e.stroke(),this.externalPT&&1<t&&(e.beginPath(),e.arc(this.mouse.position.x,this.mouse.position.y,3,0,2*Math.PI,!1),e.fillStyle=this.panel.crosshairColor,e.fill(),e.lineWidth=1)}},t.prototype._renderAnnotations=function(){var e=this;if(this.panel.showTimeAxis&&this.annotations){var t=this.context,n=this.panel.rowHeight,i=this._renderDimensions.width,o=this._renderDimensions.rowsHeight;t.font=this.panel.textSizeTime+'px "Open Sans", Helvetica, Arial, sans-serif',t.fillStyle="#7FE9FF",t.textAlign="left",t.strokeStyle="#7FE9FF",t.textBaseline="top",t.setLineDash([3,3]),t.lineDashOffset=0,t.lineWidth=2;var a=s.default.isUndefined(this.range.from)?null:this.range.from.valueOf(),r=s.default.isUndefined(this.range.to)?null:this.range.to.valueOf();s.default.forEach(this.annotations,function(s){t.setLineDash([3,3]);var l=!1;if(s.source.iconColor?(t.fillStyle=s.source.iconColor,t.strokeStyle=s.source.iconColor):void 0===s.annotation?(t.fillStyle="#7FE9FF",t.strokeStyle="#7FE9FF"):(l=!0,t.fillStyle="#EA0F3B",t.strokeStyle="#EA0F3B"),e._drawVertical(t,s.time,a,r,0,o,i,l),s.isRegion){e._drawVertical(t,s.timeEnd,a,r,0,o,i,l);var h=0+(s.time-a)/(r-a)*i,u=0+(s.timeEnd-a)/(r-a)*i;t.beginPath(),t.moveTo(h,o+5),t.lineTo(u,o+5),t.lineWidth=4,t.setLineDash([]),t.stroke(),!1===l&&(t.save(),t.fillStyle="#7FE9FF",t.globalAlpha=.2,t.fillRect(h,0,u-h,n),t.stroke(),t.restore())}})}},t.prototype._drawVertical=function(e,t,n,i,o,s,a,r){var l=o+(t-n)/(i-n)*a;if(e.lineWidth=1,e.beginPath(),e.moveTo(l,s+5),e.lineTo(l,0),e.stroke(),e.moveTo(l+0,s),e.lineTo(l-5,s+7),e.lineTo(l+5,s+7),e.fill(),!0===r){var h=e.measureText("▲").width/2;e.fillText("▲",l-h,s+10)}},t.templateUrl="partials/module.html",t.scrollable=!0,t}(i.CanvasPanelCtrl);t.PanelCtrl=f},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CanvasPanelCtrl=void 0;var i=n(6),o=r(n(0)),s=r(n(1)),a=r(n(2));function r(e){return e&&e.__esModule?e:{default:e}}var l,h=(l=function(e,t){return(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}l(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),u=function(e){function t(t,n){var i=e.call(this,t,n)||this;return i.data=null,i.mouse={position:null,down:null},i.$tooltip=(0,s.default)('<div class="graph-tooltip">'),i.events.on("panel-initialized",i.onPanelInitialized.bind(i)),i.events.on("refresh",i.onRefresh.bind(i)),i.events.on("render",i.onRender.bind(i)),i._devicePixelRatio=1,void 0!==window.devicePixelRatio&&(i._devicePixelRatio=window.devicePixelRatio),i}return h(t,e),t.$inject=["$scope","$injector"],t.prototype.onPanelInitialized=function(){this.render()},t.prototype.onRefresh=function(){this.render()},t.prototype.onRender=function(){if(this.context){console.log("canvas render",this.mouse);var e=this.wrap.getBoundingClientRect(),t=Math.max(this.height,100),n=e.width;this.canvas.width=n;var i=(this.canvas.height=t)/2,s=this.context;s.lineWidth=1,s.textBaseline="middle";var a="";if(null!=this.mouse.position&&(a=this.dashboard.formatDate((0,o.default)(this.mouse.position.ts))),s.fillStyle="#999999",s.fillRect(0,0,n,t),s.fillStyle="#111111",s.font='24px "Open Sans", Helvetica, Arial, sans-serif',s.textAlign="left",s.fillText("Mouse @ "+a,10,i),null!=this.mouse.position)if(null!=this.mouse.down){var r=Math.min(this.mouse.position.x,this.mouse.down.x),l=Math.max(this.mouse.position.x,this.mouse.down.x);s.globalCompositeOperation="destination-out",s.fillStyle="rgba(255, 255, 255, 0.6)",s.beginPath(),s.fillRect(0,0,r,t),s.fill(),s.beginPath(),s.fillRect(l,0,n,t),s.fill(),s.globalCompositeOperation="source-over"}else s.strokeStyle="#111",s.beginPath(),s.moveTo(this.mouse.position.x,0),s.lineTo(this.mouse.position.x,t),s.lineWidth=3,s.stroke(),s.beginPath(),s.moveTo(this.mouse.position.x,0),s.lineTo(this.mouse.position.x,t),s.strokeStyle="#e22c14",s.lineWidth=2,s.stroke()}else console.log("No context!")},t.prototype.clearTT=function(){this.$tooltip.detach()},t.prototype.getMousePosition=function(e){var t=this.range.to-this.range.from,n=this.canvas.getBoundingClientRect(),i=e.offsetX,o=this.range.from+t*(i/parseFloat(n.width)),s=e.clientY-n.top;return{x:i,y:s,yRel:s/parseFloat(n.height),ts:o,evt:e}},t.prototype.onGraphHover=function(e,t,n){console.log("HOVER",e,t,n)},t.prototype.onMouseClicked=function(e,t){console.log("CANVAS CLICKED",e,t),this.render()},t.prototype.onMouseSelectedRange=function(e,t){console.log("CANVAS Range",e,t)},t.prototype.link=function(e,t,n,i){var r=this;this.wrap=t.find(".canvas-spot")[0],this.canvas=document.createElement("canvas"),this.wrap.appendChild(this.canvas),(0,s.default)(this.canvas).css("cursor","pointer"),(0,s.default)(this.wrap).css("width","100%"),this.context=this.canvas.getContext("2d"),this.canvas.addEventListener("mousemove",function(e){if(r.range){r.mouse.position=r.getMousePosition(e);var t={pos:{pageX:e.pageX,pageY:e.pageY,x:r.mouse.position.ts,y:r.mouse.position.y,panelRelY:r.mouse.position.yRel,panelRelX:r.mouse.position.xRel},evt:e,panel:r.panel};a.default.emit("graph-hover",t),null!=r.mouse.down&&(0,s.default)(r.canvas).css("cursor","col-resize")}},!1),this.canvas.addEventListener("mouseout",function(e){null==r.mouse.down&&(r.mouse.position=null,r.onRender(),r.$tooltip.detach(),a.default.emit("graph-hover-clear"))},!1),this.canvas.addEventListener("mousedown",function(e){r.mouse.down=r.getMousePosition(e)},!1),this.canvas.addEventListener("mouseenter",function(e){r.mouse.down&&!e.buttons&&(r.mouse.position=null,r.mouse.down=null,r.onRender(),r.$tooltip.detach(),a.default.emit("graph-hover-clear")),(0,s.default)(r.canvas).css("cursor","pointer")},!1),this.canvas.addEventListener("mouseup",function(e){r.$tooltip.detach();var t=r.getMousePosition(e);if(null!=r.mouse.down)if(t.x===r.mouse.down.x&&t.y===r.mouse.down.y)r.mouse.position=null,r.mouse.down=null,r.onMouseClicked(t,e);else{var n=Math.min(r.mouse.down.ts,t.ts),i=Math.max(r.mouse.down.ts,t.ts),s={from:o.default.utc(n),to:o.default.utc(i)};r.mouse.position=t,r.onMouseSelectedRange(s,e)}r.mouse.down=null,r.mouse.position=null},!1),this.canvas.addEventListener("dblclick",function(e){r.mouse.position=null,r.mouse.down=null,r.onRender(),r.$tooltip.detach(),a.default.emit("graph-hover-clear"),console.log("TODO, ZOOM OUT")},!0),a.default.on("graph-hover",function(e){var t=e.panel.id===r.panel.id;if((r.dashboard.sharedTooltipModeEnabled()||t)&&!r.otherPanelInFullscreenMode()){if(!t){if(!e.pos.x||!r.range)return;var n=e.pos.x,i=r.canvas.getBoundingClientRect(),o=r.range.to-r.range.from,s=(n-r.range.from)/o*i.width;r.mouse.position={x:s,y:e.pos.panelRelY*i.height,yRel:e.pos.panelRelY,ts:n,gevt:e}}r.onGraphHover(e,t||!r.dashboard.sharedCrosshairModeOnly(),!t)}},e),a.default.on("graph-hover-clear",function(e,t){r.mouse.position=null,r.mouse.down=null,r.render(),r.$tooltip.detach()},e)},t.prototype.time_format=function(e,t){return t<=45?"%H:%M:%S":t<=7200||e<=864e5?"%H:%M":t<=8e4?"%m/%d %H:%M":t<=2419200||e<=31536e6?"%m/%d":"%Y-%m"},t.prototype.getTimeResolution=function(e){var t=e/1e3;return t<=30?3e4:t<=60?6e4:t<=300?3e5:t<=600?6e5:t<=1800?18e5:t<=3600?36e5:t<=3600?36e5:t<=7200?72e5:t<=21600?216e5:t<=43200?432e5:t<=86400?864e5:t<=172800?1728e5:t<=604800?6048e5:t<=2592e3?2592e6:15552e6},t.prototype.roundDate=function(e,t){return e-e%t},t.prototype.formatDate=function(e,t){var n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],i=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];if("function"==typeof e.strftime)return e.strftime(t);var o,s=[],a=!1,r=e.getHours(),l=r<12;o=12<r?r-12:0===r?12:r;for(var h=0;h<t.length;++h){var u=t.charAt(h);if(a){switch(u){case"a":u=""+i[e.getDay()];break;case"b":u=""+n[e.getMonth()];break;case"d":u=this.leftPad(e.getDate(),"");break;case"e":u=this.leftPad(e.getDate()," ");break;case"h":case"H":u=this.leftPad(r,null);break;case"I":u=this.leftPad(o,null);break;case"l":u=this.leftPad(o," ");break;case"m":u=this.leftPad(e.getMonth()+1,"");break;case"M":u=this.leftPad(e.getMinutes(),null);break;case"q":u=""+(Math.floor(e.getMonth()/3)+1);break;case"S":u=this.leftPad(e.getSeconds(),null);break;case"y":u=this.leftPad(e.getFullYear()%100,null);break;case"Y":u=""+e.getFullYear();break;case"p":u=l?"am":"pm";break;case"P":u=l?"AM":"PM";break;case"w":u=""+e.getDay()}s.push(u),a=!1}else"%"===u?a=!0:s.push(u)}return s.join("")},t.prototype.leftPad=function(e,t){return t=""+(null==t?"0":t),1===(e=""+e).length?t+e:e},t}(i.MetricsPanelCtrl);t.CanvasPanelCtrl=u},function(e,t){e.exports=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DistinctPoints=t.LegendValue=t.PointInfo=void 0;var i,o=(i=n(3))&&i.__esModule?i:{default:i};t.PointInfo=function(e,t){this.ms=0,this.val=e,this.start=t};t.LegendValue=function(e){this.ms=0,this.count=0,this.per=0,this.val=e};var s=function(){function e(e){this.name=e,this.changes=[],this.legendInfo=[],this.last=null,this.asc=!1,this.transitionCount=0,this.distinctValuesCount=0,this.elapsed=0}return e.prototype.add=function(e,t){if(null==this.last)this.last={val:t,start:e,ms:0},this.changes.push(this.last);else{if(e===this.last.start)return void console.log("skip point with duplicate timestamp",e,t);if(1===this.changes.length&&(this.asc=e>this.last.start),e>this.last.start!==this.asc)return void console.log("skip out of order point",e,t);t===this.last.val?this.asc||(this.last.start=e):(this.last={val:t,start:e,ms:0},this.changes.push(this.last))}},e.prototype.finish=function(e){var t=this;if(this.changes.length<1)console.log("no points found!");else{if(this.asc||(this.last=this.changes[0],o.default.reverse(this.changes)),this.last.start<e.range.to){var n=e.range.to+1;this.changes.push({val:this.last.val,start:n,ms:0})}this.transitionCount=0;for(var i=new Map,s=this.changes[0],a=1;a<this.changes.length;a++){var r=this.changes[a],l=s.start,h=r.start;if(l<e.range.from?l=e.range.from:l<e.range.to&&this.transitionCount++,h>e.range.to&&(h=e.range.to),s.ms=h-l,0<s.ms)if(i.has(s.val)){var u=i.get(s.val);u.ms+=s.ms,u.count++}else i.set(s.val,{val:s.val,ms:s.ms,count:1,per:0});s=r}var d=e.range.to-e.range.from;this.elapsed=d,i.forEach(function(e,n){e.per=e.ms/d,t.legendInfo.push(e)}),this.distinctValuesCount=o.default.size(this.legendInfo),e.isTimeline||(this.legendInfo=o.default.orderBy(this.legendInfo,["ms"],["desc"]))}},e.combineLegend=function(t,n){if(1===t.length)return t[0];var i=new e("merged"),s=0,a=new Map;return o.default.forEach(t,function(e){i.transitionCount+=e.transitionCount,s+=e.elapsed,o.default.forEach(e.legendInfo,function(e){if(a.has(e.val)){var t=a.get(e.val);t.ms+=e.ms,t.count+=e.count}else a.set(e.val,{val:e.val,ms:e.ms,count:e.count,per:0})})}),i.elapsed=s,a.forEach(function(e,t){e.per=e.ms/s,i.legendInfo.push(e)}),i.distinctValuesCount=o.default.size(i.legendInfo),i},e}();t.DistinctPoints=s},function(e,t){e.exports=s}])});
//# sourceMappingURL=module.js.map